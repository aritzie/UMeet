<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:fragment="layout(htmlcuerpo)">

<head>
    <title>UMeet - ¡Chatea con tus amigos!</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="/styles.css">
    <link rel="icon" type="image/png" href="/una.png" sizes="16x16">
</head>

<body>
    <div>
        <div class="row"> 
            <div class="col-md-12">
                <nav class="navbar navbar-expand-lg navbar-light bg-light navbar-dark bg-dark container-fluid"> 
                    <div class="container-fluid padre">
                        <div class="col-4 row hijo">
                            <div class="col-2">
                                <a class="nav-link" href="/home" style="margin-left: -50px;">
                                    <img src="/una.png" class="avatar ml-4">
                                </a>
                            </div>
                            <!-- Amigos -->
                            <ul class="navbar-nav col-5">
                                <li class="nav-item active">
                                    <a class="nav-link" href="/friends/friendsList">
                                        <mystyle>
                                            <i class="fas fa-user-friends"></i>Amigos
                                        </mystyle>
                                    </a>
                                </li>
                            </ul>
                            <!-- Mostrar servidores -->
                            <ul class="navbar-nav col-5">
                                <li class="nav-item active">
                                    <a class="nav-link" id="inventado" onclick="servidor()">
                                        <mystyle>
                                            <i class="fas fa-server"></i> Servidores
                                        </mystyle>
                                    </a>
                                </li>
                            </ul>
                        </div>
                        <div class="col-8 row hijo">                            
                            <!-- Lista servidores y anyadir -->
                            <div>
                                <a class="avatar" th:onclick="|editServer()|"><img class="avatar" src="/plus.svg"/></a>
                            </div>
                            <div class="col-9 ">
                                <div id="userServers" class="overflow-auto "></div>
                            </div>

                            <!-- Perfil usuario -->
                            <div class="navbar-nav  row col-2 ml-4">
                                <div class="dropdown">
                                    <a class="nav-link" role="button" id="user-profile"
                                    data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                    </a>
                                    <div class="dropdown-menu" aria-labelledby="dropdownMenuLink">
                                        <a class="dropdown-item" href="/profile/view">Ver Perfil</a>
                                        <a class="dropdown-item" onclick="editProfile()">Editar Perfil</a>
                                        <a th:href="@{/logout}"class="btn btn-success align-items-center dropdown-item">Desconectar</a>
                                    </div>
                                </div>
                                <div class="dropdown">
                                    <a role="button" data-toggle="dropdown" aria-haspopup="true" id="user-status"
                                        aria-expanded="false">
                                        &nbsp;
                                    </a>
                                    <div class="dropdown-menu" aria-labelledby="user-profile">
                                        <a onClick="editStatus('conectado')" class="dropdown-item">Conectado</a>
                                        <a onClick="editStatus('desconectado')" class="dropdown-item">Desconectado</a>
                                        <a onClick="editStatus('ocupado')" class="dropdown-item">Ocupado</a>
                                        <a onClick="editStatus('ausente')" class="dropdown-item">Ausente</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </nav>

                <div class="" style="text-align: center; align-content:center;">
                    <div id="contentBody" class="">
                        <th:block th:include="${htmlcuerpo}"/>
                    </div>
                </div>
                <footer>
                    <div class="row">
                        <div class="offset-5 col-6 mt-4 mb-2">
                              <p> © Copyright 2021 U meet. Todos los Derechos Reservados <p>
                            
                        </div>
                      
                    </div>
                </footer>
                <div id = "pot" class="invis">
                    <img src = "/estepi.png" width = "50px" height ="50px">
                </div>
            </div>
        </div>
    </div>

    <myscripts th:fragment="scripts">
        <script src="https://code.jquery.com/jquery-3.6.0.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.11.0/umd/popper.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/bootbox.js/5.5.2/bootbox.js"></script>
        <script>
            $(document).ready(function () {
                loadProfile();
                loadServers();
                msgSize();
                $( ".pulsador" ).click( function() {
                    $(this).prev().toggleClass("flip");
                });
                setTimeout(function(){$("#pot").toggleClass("invis")}, 66000);
                //$("#pot").toggleClass("invis");
            });
            function msgSize() {
                var height = $(window).height();

                $('#contentChat').height(height * 0.6);
                $('#contentServer').height(height * 0.55);
            }
            function loadProfile() {
                $.ajax({
                    url: "/profile/getUser",
                    success: function (pHtml) {

                        $("#user-profile").html('<span class="name">'+pHtml.username +'</span>');
                        $("#user-status").html('<span class="avatar" style="position:absolute">'+
                                                    '<img alt="Avatar" class="avatar" src="/profile/avatar?url=' +pHtml.avatar + '">'+
                                                    '<span class="status-2 '+ pHtml.status + '"></span>'+
                                                '</span>');
                        
                    },
                    error: function (xhr, status, error) {
                        console.log(xhr.responseText);
                        window.location = "/logout";
                    }
                });
            }
            function editStatus(status) {
                $.ajax({
                    url: "/profile/statusDrop",
                    data: {
                        status: status
                    },
                    success: function (pHtml) {
                        loadProfile();
                    },
                    error: function (xhr, status, error) {
                        console.log(xhr.responseText);
                    }
                });
            }
            function editProfile() {
                $.ajax({
                    url: "/profile/edit",
                    success: function (pHtml) {
                        bootbox.dialog({
                            title: 'Editar perfil',
                            size: "large",
                            message: pHtml
                        })
                    },
                    error: function (xhr, status, error) {
                        console.log(xhr.responseText);
                    }
                });
            }
            function loadServers() {
                //userServers
                $.ajax({
                    type: "POST",
                    url: "/server/byUser",
                    success: function (pJson) {
                        //loadProfile();
                        //console.log(pJson);
                        $("#userServers").html("");
                        var salida = " ";
                        for (x of pJson) {
                            var URLactual = location.href;
                            console.log(location.href)
                            var id = URLactual.split("=");
                            
                            if(id[1] == x.id){
                                salida += "<a href=/server/one?idServer=" + x.id + " id='"+x.id+"' style='border-top: 2px solid white'>" +
                                "<img class='avatar' src=/profile/avatar?url=" + x.avatar + " style='margin: 6px;'>" +
                                "</a>";
                            }else{
                                salida += "<a href=/server/one?idServer=" + x.id + " id='"+x.id+"'>" +
                                "<img class='avatar' src=/profile/avatar?url=" + x.avatar + " style='margin: 6px;'>" +
                                "</a>";
                            }                      
                        }
                        //console.log(salida);
                        $("#userServers").append(salida);
                    },
                    error: function (xhr, status, error) {
                        alert(xhr.responseText);
                    }
                });
            }
            function servidor() {
                $.ajax({
                    type: "POST",
                    url: "/server/allServers",
                    success: function (pHtml) {
                        $("body").html(pHtml);
                    },
                    error: function (xhr, status, error) {
                        console.log(xhr.responseText);
                    }
                });
            }

            function chat(idCanal, channelName) {
                $.ajax({
                    type: "POST",
                    url: "/msg/channel/" + idCanal,
                    success: function (pJson) {
                        console.log(pJson);
                        $("#channel-name").html(channelName);
                        $("#sendit").html("<input type='text' id='sendMsg' name='text' placeholder='Escribe un mensaje'>" +
                            "<a onclick=enviarMsgCanal(" + idCanal + ") ><i class='fnt-aws-size far fa-paper-plane'></i></a>"
                            + "   <a onclick=enviarMsgFileCanal(" + idCanal + ") ><i class='fnt-aws-size fas fa-paperclip'></i></a>");
                        var salida = $("<tr>").html("<div class='h2 mx-5 my-5 text-aling-center'>¡Te damos la bienvenida al canal!<br><br></div>");
                        $("#contentChat").html("");
                        for (x of pJson) {
                            console.log(x);
                            $("<tr>").html("<td><p><span class='mensaje'><img alt='Avatar' class='avatar-msg' src=/profile/avatar?url=" + x.user.avatar + " />  " + x.user.nickName + ":<br></span><span class='mensaje-2'> " + x.text + "</span></p></td>").appendTo(salida);
                        }
                        salida.appendTo("#contentChat");

                        $('#contentChat').scrollTop($('#contentChat').prop('scrollHeight'));
                        setTimeout(function(){chat(idCanal)}, 20000);
                    },
                    error: function (xhr, status, error) {
                        console.log(xhr.responseText);
                    }
                });
            }
            function enviarMsgCanal(idCanal) {
                var msg = $("#sendMsg").val();
                if (msg.length > 0 && msg != " ") {

                    //alert($("#sendMsg").val().length);
                    $.ajax({
                        type: "POST",
                        url: "/msg/channel/sendmsg",
                        data: {
                            idChannel: idCanal, //Obtener id con las cookies del usuario 
                            text: $("#sendMsg").val()
                        },
                        success: function (pJson) {
                            console.log("Mensaje enviado");
                            chat(idCanal);

                            $('#contentChat').scrollTop($('#contentChat').prop('scrollHeight'));
                        },
                        error: function (xhr, status, error) {
                            console.log(xhr.responseText);
                        }
                    });
                }
            }
            //Rueda mouse horizontal 
            var item = document.getElementById("userServers");
            window.addEventListener("wheel", function (e) {
                if (e.deltaY > 0)
                    item.scrollLeft += 100;
                else
                    item.scrollLeft -= 100;
            });
            function chatPrivado(idDestino) {
                $.ajax({
                    type: "POST",
                    url: "/msg/private/" + idDestino,
                    success: function (pJson) {
                        //console.log(pJson);
                        $("#sendit").html("<input type='text' id='sendMsg' name='text' placeholder='Escribe un mensaje'>" +
                            "<a onclick=enviarMsgCanal(" + idDestino + ") ><i class='fnt-aws-size far fa-paper-plane'></i></a>"
                            + "   <a onclick=enviarMsgFileCanal(" + idDestino + ") ><i class='fnt-aws-size fas fa-paperclip'></i></a>");
                        var salida = $("<tr>").html("<div class='h2 mx-2 my-2 pt-4 pl-3 text-aling-center'>¡Este es el comienzo de tus mensajes privados!<br><br></div>");
                        $("#contentChat").html("");
                        for (x of pJson) {
                           // $("<tr>").html("<td><p><span class='mensaje'><img alt='Avatar' class='avatar-msg' src=/profile/avatar?url=" + x.user.avatar + " />  " + x.user.nickName + ":<br></span><span class='mensaje-2'> " + x.text + "</span></p></td>").appendTo(salida);
                            $("<tr>").html('<div class="answer left<div class="avatar"><img alt="Avatar"  src=/profile/avatar?url=' + x.user.avatar + ' /><div class="status offline"></div></div><div class="name">'+ x.user.nickName +'</div><div class="text">'+ x.text + '</div><div class="time">5 min ago</div></div>');
                        }
                        salida.appendTo("#contentChat");
                        salida.appendTo("#panelChat");
                        $('#contentChat').scrollTop($('#contentChat').prop('scrollHeight'));
                        setTimeout(function(){chatPrivado(idDestino)}, 20000);
                    },
                    error: function (xhr, status, error) {
                        console.log(xhr.responseText);
                    }
                });
            }

            function enviarMsgPrivado(idDestino) {
                $.ajax({
                    type: "POST",
                    url: "/msg/private/sendmsg",
                    data: {
                        idUserDestiny: idDestino,
                        text: $("#sendMsg").val()
                    },
                    success: function (pJson) {
                        //console.log("Mensaje enviado");
                        chatPrivado(idDestino);
                        
                        $('#contentChat').scrollTop($('#contentChat').prop('scrollHeight'));
                    },
                    error: function (xhr, status, error) {
                        console.log(xhr.responseText);
                    }
                });
            }

            function amigos() {

                $.ajax({
                    type: "POST",
                    url: "/friends/friendsFilter",
                    data: {
                        username: $("#buscaAmigo").val()

                    },
                    success: function (pHtml) {
                        $("#obtenAmigo").html(pHtml);
                    },
                    error: function (xhr, status, error) {
                        console.log(xhr.responseText);
                    }
                });
            }
            function editCategory(idServer, idCategory) {
                $.ajax({
                    url: "/category/form",
                    data: {
                        idServer: idServer,
                        idCategory: idCategory
                    },
                    success: function (html) {
                        bootbox.dialog({
                            title: 'Categoría',
                            message: html
                        })
                    },
                    error: function (xhr, status, error) {
                        console.log(xhr.responseText);
                    }
                })
            }

            function editChannel(idCategory, idChannel) {
                $.ajax({
                    url: "/channel/form",
                    data: {
                        idCategory: idCategory,
                        idChannel: idChannel
                    },
                    success: function (html) {
                        bootbox.dialog({
                            title: 'Canal',
                            message: html
                        })
                    },
                    error: function (xhr, status, error) {
                        console.log(xhr.responseText);
                    }
                })
            }
            function editServer(idServer) {
                $.ajax({
                    url: "/server/form",
                    data: {
                        idServer: idServer
                    },
                    success: function (html) {
                        bootbox.dialog({
                            title: 'Servidor',
                            message: html
                        })
                    },
                    error: function (xhr, status, error) {
                        console.log(xhr.responseText);
                    }
                })
            }
            function confirmServer(idServer, title, url){
                bootbox.confirm({
                    message: title,
                    callback: function(result){
                        if(result){
                            $.ajax({
                                url: url, //"/usr/leaveServer",
                                data: {
                                    idServer: idServer
                                },
                                success: function (html) {
                                    window.location="/home";
                                },
                                error: function (xhr, status, error) {
                                    console.log(xhr.responseText);
                                }
                            })
                        }
                    }
                })
            }
        </script>
<!--        <script>
            var contadorAfk = 0;

            $(document).ready(function() {
              setup();
              contadorAfk = setInterval(ctrlTiempo, 2000);
            });

            function ctrlTiempo() {

                contadorAfk++;
                //console.log(contadorAfk);

                if (contadorAfk > 5) {
                  contadorAfk = 0;
                  $("#pot").toggleClass("invis");
                }
            }
            
            function resetearTimer(){
                contadorAfk = 0;
            }
            
            function setup() {
                this.addEventListener("mousemove", resetearTimer, false);
                this.addEventListener("mousedown", resetearTimer, false);
                this.addEventListener("keypress", resetearTimer, false);
                this.addEventListener("DOMMouseScroll", resetearTimer, false);
                this.addEventListener("mousewheel", resetearTimer, false);
                this.addEventListener("touchmove", resetearTimer, false);
                this.addEventListener("MSPointerMove", resetearTimer, false);
            }
        </script>-->
    </myscripts>
</body>

</html>
